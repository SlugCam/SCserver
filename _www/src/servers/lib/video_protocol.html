<!DOCTYPE html><html lang="en"><head><title>servers/lib/video_protocol</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="servers/lib/video_protocol"><meta name="groc-project-path" content="servers/lib/video_protocol.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">servers/lib/video_protocol.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">Writable</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">).</span><span class="nx">Writable</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This function takes a buffer as an argument and returns the index of the
first null byte, or -1 if a null byte is not found.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">findNullByte</span><span class="p">(</span><span class="nx">buff</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nullIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">buff</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">nullIndex</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">nullIndex</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="videoprotocol-writable-stream">VideoProtocol Writable Stream</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">VideoProtocol</span><span class="p">,</span> <span class="nx">Writable</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the constructor for our stream object. It takes the a path in which
to store videos as an argument. <em>This path must already exist.</em></p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">VideoProtocol</span><span class="p">(</span><span class="nx">outputPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Writable</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">outputPath</span> <span class="o">=</span> <span class="nx">outputPath</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">camName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vidId</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">vidLength</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fileStream</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the method that requires overwriting in the Node writable stream
api. For more information, read the streams section in the Node docs. Node
will automatically call this when things are piped to the stream.</p></div></div><div class="code"><div class="wrapper"><span class="nx">VideoProtocol</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_write</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: I believe this concat will "reset" the slices, eliminating need
for further processing. This should be checked however.</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">buff</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">buff</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">]);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_scan</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>_scan</code> contains the bulk of the work, it scans through the current
buffer, while referencing the current state of our stream, either reading
meta data or piping the video data into a file.</p></div></div><div class="code"><div class="wrapper"><span class="nx">VideoProtocol</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_scan</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Continue scan starts as false, because we will scan again only if we
are able to successfully parse a value at some point (at which point we
will set it to true). If we never successfully parse a value, we know we
have consumed the entire stream.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">continueScan</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">parseResults</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This chain works because at each step, we know the rest exist, and
this protocol always goes in the same order.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">continueScan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">camName</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Waiting for cam name.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">parseResults</span> <span class="o">=</span> <span class="nx">parseString</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buff</span><span class="p">);</span>
        <span class="nx">continueScan</span> <span class="o">=</span> <span class="nx">parseResults</span><span class="p">.</span><span class="nx">success</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">camName</span> <span class="o">=</span> <span class="nx">parseResults</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">buff</span> <span class="o">=</span> <span class="nx">parseResults</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">continueScan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">vidId</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Waiting for vid id</p></div></div><div class="code"><div class="wrapper">        <span class="nx">parseResults</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buff</span><span class="p">);</span>
        <span class="nx">continueScan</span> <span class="o">=</span> <span class="nx">parseResults</span><span class="p">.</span><span class="nx">success</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">vidId</span> <span class="o">=</span> <span class="nx">parseResults</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">buff</span> <span class="o">=</span> <span class="nx">parseResults</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">continueScan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">vidLength</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Waiting for length</p></div></div><div class="code"><div class="wrapper">        <span class="nx">parseResults</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buff</span><span class="p">);</span>
        <span class="nx">continueScan</span> <span class="o">=</span> <span class="nx">parseResults</span><span class="p">.</span><span class="nx">success</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">vidLength</span> <span class="o">=</span> <span class="nx">parseResults</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">buff</span> <span class="o">=</span> <span class="nx">parseResults</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">continueScan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">fileStream</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fileStream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">getAndCheckPath</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">)</span>
        <span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We have everything we need, so open up a file stream</p></div></div><div class="code"><div class="wrapper">    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">continueScan</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fileStream</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buff</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Everything is setup, so just write to the file stream</p></div></div><div class="code"><div class="wrapper">    <span class="p">}</span>


    <span class="c1">//TODO remove else, check for continue to new video</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">camName</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">vidId</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">vidLength</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO this could be more robust.</p></div></div><div class="code"><div class="wrapper"><span class="nx">VideoProtocol</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getAndCheckPath</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">camDir</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outputPath</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">camName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">camDir</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">mkdirSync</span><span class="p">(</span><span class="nx">camDir</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">camDir</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">vidId</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="parsing-functions">Parsing Functions</h2>

<p>These functions are used to parse individual elements from a buffer and
return an object containing the following:
- success: boolean that is true if we were able to parse
- value: the parsed value, this will be null if unable to parse
- buffer: a slice containing the remainder of the buffer</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>parseString(buff)</code> parses the a null terminated ASCII string from the 
specified buffer.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">parseString</span><span class="p">(</span><span class="nx">buff</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">value</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">buffer</span><span class="o">:</span> <span class="nx">buff</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If we have a null byte, we know that there is a finished camera name.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">nullIndex</span> <span class="o">=</span> <span class="nx">findNullByte</span><span class="p">(</span><span class="nx">buff</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nullIndex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">success</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">nullIndex</span><span class="p">);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">nullIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>parseInt(buff)</code> parses a UInt32BE from the buffer if it is long enough.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">buff</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">value</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">buffer</span><span class="o">:</span> <span class="nx">buff</span>
    <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">buff</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">success</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">readUInt32BE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="nx">buff</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="exports">Exports</h2>

<p>This module only exports the VideoProtocol writable stream.</p></div></div><div class="code"><div class="wrapper"><span class="nx">exports</span><span class="p">.</span><span class="nx">VideoProtocol</span> <span class="o">=</span> <span class="nx">VideoProtocol</span><span class="p">;</span></div></div></div></div></body></html>