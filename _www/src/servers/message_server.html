<!DOCTYPE html><html lang="en"><head><title>servers/message_server</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="servers/message_server"><meta name="groc-project-path" content="servers/message_server.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">servers/message_server.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="message-server">Message Server</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This file contains the code for the SWEETnet message server. It is
responsible for coordinating message communication with the cameras. It is
the only way to send messages to the cameras, and receives all non-video
communication from the cameras. Logically it connects the cameras to the
database.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="todo">TODO</h2>

<p>The server will take JSON, one message object per line. JSON strings should
be newline escapes (todo check this). Make sure that the data event is
emitted after every newline.</p></div></div><div class="code"><div class="wrapper"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">exports</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We use the Node.js <code>net</code> library to facilitate TCP communication.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;net&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is our data store library. It contains the functions we use to store
messages to the database.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./lib/db.js&#39;</span><span class="p">)(</span><span class="nx">config</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Build a server object, <code>net.createServer</code> creates a server object and sets
the function to be the listener for the <code>connection</code> event. This function
receives as an argument a connection object which is an instance of
<code>net.Socket</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//&#39;connection&#39; listener</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;message server connected&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The end event is emitted by the connection when the connection is
disconnected.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">c</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;message server disconnected&#39;</span><span class="p">);</span>
        <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The data event is emitted when data is received.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">c</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">storeMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If this is the first message retrieved, find camera name and start
sending pending messages.</p></div></div><div class="code"><div class="wrapper">        <span class="p">});</span>

        <span class="nx">c</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;hello\r\n&#39;</span><span class="p">);</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>listen starts the server listening on the given port.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">exports</span><span class="p">.</span><span class="nx">listen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;message server bound to port &#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="nx">exports</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">messageServer</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;message server bound to port &#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">messageServer</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">exports</span><span class="p">;</span>
<span class="p">};</span></div></div></div></div></body></html>